name: God Mode APK Builder

on:
  repository_dispatch:
    types: [build_apk]

jobs:
  build:
    name: Build Ultra-Secure APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Dependencies
        run: |
          npm install -g cordova
          npm install -g cordova-res
          npm install javascript-obfuscator

      - name: Initialize App
        run: |
          cordova create myApp ${{ github.event.client_payload.package_name }} "${{ github.event.client_payload.app_name }}"
          cd myApp
          cordova platform add android

      # --- FETCH SOURCE (MULTI-FILE FIX DONE HERE) ---
      # Yeh step ab Folder ko detect karega aur SAARI files copy karega
      - name: Fetch Source & Assets
        run: |
          # Payload se path milega: apk_source/UID/index.html
          FULL_PATH="${{ github.event.client_payload.source_path }}"
          
          # Hum file ke folder ka path nikalenge: apk_source/UID
          SOURCE_DIR=$(dirname "$FULL_PATH")
          
          echo "üìÇ Project Directory detected at: $SOURCE_DIR"
          
          if [ -d "$SOURCE_DIR" ]; then
            echo "‚úÖ Source folder found. Cleaning default files..."
            
            # Cordova ki default index.html aur css/js hatao
            rm -rf myApp/www/*
            
            # User ke folder ki SAARI files (HTML, CSS, JS, IMG) www folder mein copy karo
            cp -r "$SOURCE_DIR/"* myApp/www/
            
            echo "‚úÖ All project files copied successfully!"
            echo "üìÑ File List in APK:"
            ls -R myApp/www/
          else
            echo "‚ùå Error: Project folder missing at $SOURCE_DIR"
            exit 1
          fi

      # --- üíÄ DARK CYBER GOD MODE ENCRYPTION üíÄ ---
      - name: üõ°Ô∏è Apply Dark Cyber Protection
        working-directory: ./myApp
        run: |
          echo "üîí Applying HELLO KIDS DARK CYBER Protection..."
          
          cat << 'EOF' > encrypt_engine.js
          const fs = require('fs');
          const JavaScriptObfuscator = require('javascript-obfuscator');
          
          // Target only the main entry file for wrapper, others remain linked
          const sourcePath = 'www/index.html';
          
          if (!fs.existsSync(sourcePath)) {
              console.error("‚ùå Main index.html not found! Skipping encryption.");
              process.exit(0);
          }

          try {
              let originalCode = fs.readFileSync(sourcePath, 'utf8');

              // 1. Triple Layer Encryption (Base64 -> Hex -> Base64)
              const b64 = Buffer.from(originalCode).toString('base64');
              const hex = Buffer.from(b64).toString('hex');
              const finalEnc = Buffer.from(hex).toString('base64');
              
              // 2. The Trap Loader Script
              let loaderScript = `
                  (function(_0xInput){
                      console.log("HELLO KIDS üåö DARK CYBER ü•∂üñï"); 
                     
                      // Anti-Debug Logic
                      setInterval(function(){
                          var _0xStart = new Date().getTime();
                          debugger; 
                          if (new Date().getTime() - _0xStart > 100) {
                              document.body.innerHTML = '<h1 style="color:red;text-align:center;margin-top:50px;">‚ö†Ô∏è SECURITY VIOLATION ‚ö†Ô∏è</h1>';
                              throw new Error("Dark Cyber Triggered");
                          }
                      }, 2000);
                      
                      // Decryption Logic
                      var _0xHex = window.atob(_0xInput);
                      var _0xBase = _0xHex.match(/.{1,2}/g).map(function(v){return String.fromCharCode(parseInt(v, 16))}).join('');
                      var _0xHtml = decodeURIComponent(escape(window.atob(_0xBase)));
                      
                      document.open();
                      document.write(_0xHtml);
                      document.close();
                  })("${finalEnc}");
              `;
              
              console.log("üî• Encrypting Entry Point...");

              // 3. OPTIMIZED OBFUSCATION
              const obfuscationResult = JavaScriptObfuscator.obfuscate(loaderScript, {
                  compact: true,
                  simplify: true,
                  identifierNamesGenerator: 'mangled', 
                  identifiersPrefix: 'DARK_CYBER',
                  stringArray: true,
                  stringArrayEncoding: ['rc4'],
                  stringArrayThreshold: 1, 
                  splitStrings: false,
                  controlFlowFlattening: false,
                  selfDefending: true, 
                  debugProtection: true,
                  disableConsoleOutput: true
              });

              const finalHtml = `<!DOCTYPE html><html><head><meta charset="utf-8"></head><body><script>${obfuscationResult.getObfuscatedCode()}</script></body></html>`;
              
              fs.writeFileSync(sourcePath, finalHtml);
              console.log("‚úÖ DARK CYBER Protection Applied!");
          
          } catch (err) {
              console.error("Encryption Failed:", err);
              process.exit(1);
          }
          EOF
          
          node encrypt_engine.js

      # --- INJECT CONFIG ---
      - name: Inject Config
        working-directory: ./myApp
        run: |
          if [ "${{ github.event.client_payload.permissions.camera }}" == "true" ]; then
            sed -i '/<\/widget>/i \    <config-file parent="/*" target="AndroidManifest.xml"><uses-permission android:name="android.permission.CAMERA" /></config-file>' config.xml
          fi
          if [ "${{ github.event.client_payload.permissions.mic }}" == "true" ]; then
             sed -i '/<\/widget>/i \    <config-file parent="/*" target="AndroidManifest.xml"><uses-permission android:name="android.permission.RECORD_AUDIO" /></config-file>' config.xml
          fi
          if [ "${{ github.event.client_payload.permissions.location }}" == "true" ]; then
             sed -i '/<\/widget>/i \    <config-file parent="/*" target="AndroidManifest.xml"><uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" /></config-file>' config.xml
          fi

          # Custom Icon Logic (Checks parent dir because "Fetch Source" moves files)
          if [ "${{ github.event.client_payload.has_custom_icon }}" == "true" ]; then
             # Icon is now inside www folder because of cp -r
             ICON_FILE="www/icon.png"
             echo "‚úÖ Checking for Custom Icon at: $ICON_FILE"
             
             if [ -f "$ICON_FILE" ]; then
                 sed -i '/<\/widget>/i \    <icon src="www/icon.png" />' config.xml
             else
                 echo "‚ö†Ô∏è Icon file not found in www folder."
             fi
          fi

      # --- INJECT PERMISSIONS SCRIPT ---
      - name: Inject Permissions Handler
        working-directory: ./myApp
        run: |
          cordova plugin add cordova-plugin-android-permissions
          PERM_SCRIPT="<script>document.addEventListener('deviceready',function(){try{var p=cordova.plugins.permissions;var list=[];if(${{ github.event.client_payload.permissions.camera }})list.push(p.CAMERA);if(${{ github.event.client_payload.permissions.mic }})list.push(p.RECORD_AUDIO);if(${{ github.event.client_payload.permissions.location }})list.push(p.ACCESS_FINE_LOCATION);if(list.length>0){p.requestPermissions(list,function(s){},function(e){});}}catch(e){}},false);</script>"
          
          # Inject script into index.html (works even if encrypted because we overwrite body/head logic inside encryption)
          # Note: Since encryption overwrites the file, we should inject permissions BEFORE encryption ideally, 
          # BUT our encryption script writes a NEW html structure. 
          # However, Cordova plugins load via webview. For "Dark Cyber" mode, manual permission request might be hidden by encryption.
          # We will skip injecting into HTML body to avoid breaking the encrypted blob, relying on manifest permissions instead.
          echo "Skipping JS permission injection to maintain encryption integrity. Manifest permissions applied."

      # --- BUILD ---
      - name: Build Android APK
        working-directory: ./myApp
        run: cordova build android --debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.client_payload.app_name }}-APK
          path: myApp/platforms/android/app/build/outputs/apk/debug/app-debug.apk
          
